<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>자물쇠 비밀번호 풀기</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #2c3e50; font-size: 24px; }
    .box {
      border: 2px solid #ccc;
      padding: 16px;
      background-color: #f9f9f9;
      margin-top: 20px;
    }
    select, button {
      padding: 10px;
      font-size: 16px;
    }
    #timer {
      font-size: 20px;
      margin-top: 10px;
      color: #e74c3c;
      text-align: center;
    }
    .input-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .input-box {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    input.digit {
      width: 50px;
      height: 50px;
      font-size: 24px;
      text-align: center;
    }
    .timer-control {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 20px;
      gap: 10px;
      justify-content: center;
    }
    .feedback-list li {
      margin-bottom: 4px;
      font-size: 16px;
    }
    .hint-box {
      text-align: center;
      margin-top: 15px;
      font-size: 16px;
      color: #2c3e50;
    }

    @media (max-width: 600px) {
      h1 { font-size: 20px; }
      input.digit {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      button, select {
        font-size: 14px;
        padding: 8px;
      }
    }
  </style>
</head>
<body>

  <h1>🔐 자물쇠 비밀번호 풀기</h1>

  <div class="box">
    <h3>📘 지문</h3>
    <p>난이도를 선택하면 매번 다른 조건의 자물쇠 문제와 정답이 생성됩니다.</p>
    <label>🧩 난이도 선택: </label>
    <select id="difficulty" onchange="generateProblem(true)">
      <option value="easy">쉬움</option>
      <option value="medium" selected>보통</option>
      <option value="hard">어려움</option>
    </select>
    <button onclick="showHint()">💡 힌트</button>
    <div class="hint-box" id="hintBox">힌트가 여기에 표시됩니다.</div>
  </div>

  <div class="box">
    <h3>📌 규칙</h3>
    <ul id="conditionList" class="feedback-list"></ul>
  </div>

  <div class="box">
    <h3>❓ 문제</h3>
    <div class="input-row">
      <div class="input-box"><label>첫째</label><input type="text" maxlength="1" class="digit" /></div>
      <div class="input-box"><label>둘째</label><input type="text" maxlength="1" class="digit" /></div>
      <div class="input-box"><label>셋째</label><input type="text" maxlength="1" class="digit" /></div>
      <div class="input-box"><label>넷째</label><input type="text" maxlength="1" class="digit" /></div>
    </div>

    <div style="text-align:center; margin-top: 20px;">
      <button id="submitBtn" onclick="submitAnswer()">정답 제출</button>
    </div>

    <div class="timer-control">
      <label>🕒 시간 설정:</label>
      <select id="timeSelect">
        <option value="30">30초</option>
        <option value="60">1분</option>
        <option value="90">1분 30초</option>
        <option value="120">2분</option>
        <option value="150">2분 30초</option>
        <option value="180">3분</option>
      </select>
      <button onclick="startTimer()">⏳ 시간 시작</button>
      <button onclick="pauseTimer(this)">⏸️ 시간 멈춤</button>
    </div>

    <div id="timer"></div>
  </div>

  <script>
    let countdown, remainingTime = 0, timerPaused = false;
    let correctAnswer = "", currentConditions = [], hintStep = 0;

    const digits = document.querySelectorAll('.digit');
    const utils = {
      randInt: (min, max) => Math.floor(Math.random() * (max - min + 1)) + min,
      shuffle: (arr) => arr.sort(() => Math.random() - 0.5)
    };

    const generators = {
      easy: () => {
        const a = utils.randInt(1, 3);
        const b = utils.randInt(4, 6);
        const c = utils.randInt(7, 8);
        const d = 9;
        correctAnswer = `${a}${b}${c}${d}`;
        return {
          rules: [
            `첫째 자리는 ${a}입니다.`,
            `둘째 자리는 ${b}입니다.`,
            `셋째 자리는 ${c}입니다.`,
            `넷째 자리는 9입니다.`
          ],
          check: (digs) => [digs[0] == a, digs[1] == b, digs[2] == c, digs[3] == "9"]
        };
      },
      medium: () => {
        const a = utils.shuffle([1, 3])[0];
        const c = utils.shuffle([2, 4])[0];
        const b = c + 1;
        const d = utils.shuffle([6, 8])[0];
        correctAnswer = `${a}${b}${c}${d}`;
        return {
          rules: [
            "첫째 자리수는 5보다 작은 홀수입니다.",
            "셋째 자리는 5보다 작은 짝수입니다.",
            "둘째 자리와 셋째 자리는 연속된 수입니다.",
            "넷째 자리수는 6 또는 8입니다.",
            "첫째 + 넷째 = 둘째 + 셋째입니다."
          ],
          check: (d) => {
            const [A, B, C, D] = d.map(Number);
            return [
              [1, 3].includes(A),
              [2, 4].includes(C),
              Math.abs(B - C) === 1,
              [6, 8].includes(D),
              A + D === B + C
            ];
          }
        };
      },
      hard: () => {
        const a = 5;
        const b = utils.randInt(6, 7);
        const c = utils.shuffle([6, 8])[0];
        const d = 9;
        correctAnswer = `${a}${b}${c}${d}`;
        return {
          rules: [
            "첫째 자리는 5입니다.",
            "둘째 자리는 첫째보다 큽니다.",
            "셋째 자리는 짝수입니다.",
            "넷째 자리는 9입니다.",
            "모든 숫자는 5 이상입니다."
          ],
          check: (d) => {
            const [A, B, C, D] = d.map(Number);
            return [
              A === 5,
              B > A,
              C % 2 === 0,
              D === 9,
              d.every(n => +n >= 5)
            ];
          }
        };
      }
    };

    function generateProblem(resetHint = false) {
      const level = document.getElementById("difficulty").value;
      const { rules, check } = generators[level]();
      currentConditions = check;
      correctAnswer = correctAnswer;
      localStorage.setItem('lockAnswer', correctAnswer);
      localStorage.setItem('lockRules', JSON.stringify(rules));
      localStorage.setItem('lockLevel', level);

      const list = document.getElementById("conditionList");
      list.innerHTML = "";
      rules.forEach((r, i) => {
        const li = document.createElement("li");
        li.id = `cond${i}`;
        li.innerHTML = `🔲 ${r}`;
        list.appendChild(li);
      });

      digits.forEach(i => { i.value = ""; i.disabled = false; });
      document.getElementById("submitBtn").disabled = false;
      if (resetHint) {
        hintStep = 0;
        document.getElementById("hintBox").innerText = "힌트가 여기에 표시됩니다.";
      }
    }

    function showHint() {
      hintStep++;
      const hintBox = document.getElementById("hintBox");
      if (hintStep === 1) {
        hintBox.innerText = `힌트 1: 첫 숫자는 ${correctAnswer[0]}보다 작거나 같습니다.`;
      } else if (hintStep === 2) {
        hintBox.innerText = `힌트 2: 마지막 숫자는 ${correctAnswer[3]}입니다.`;
      } else {
        hintBox.innerText = `힌트 3: 정답은 ${correctAnswer}입니다!`;
      }
    }

    function submitAnswer() {
      const inputs = Array.from(digits).map(i => i.value);
      if (inputs.some(v => isNaN(v) || v === "")) {
        alert("⚠️ 모든 칸에 숫자를 입력해주세요.");
        return;
      }

      const checks = currentConditions(inputs);
      checks.forEach((pass, i) => {
        const el = document.getElementById(`cond${i}`);
        el.innerHTML = `${pass ? "✅" : "❌"} ${el.innerText.slice(2)}`;
        el.style.color = pass ? "green" : "red";
      });

      if (checks.every(Boolean)) {
        alert("🎉 정답입니다! 자물쇠가 열렸습니다.");
        clearInterval(countdown);
        disableInputs();
      } else {
        alert("❌ 정답이 아닙니다. 조건을 다시 확인해보세요.");
      }
    }

    function startTimer() {
      clearInterval(countdown);
      remainingTime = parseInt(document.getElementById("timeSelect").value);
      timerPaused = false;
      updateTimerDisplay();
      enableInputs(true);

      countdown = setInterval(() => {
        if (!timerPaused) {
          remainingTime--;
          updateTimerDisplay();
          if (remainingTime <= 0) {
            clearInterval(countdown);
            alert("⏰ 시간이 종료되었습니다!");
            disableInputs();
          }
        }
      }, 1000);
    }

    function pauseTimer(btn) {
      timerPaused = !timerPaused;
      btn.innerText = timerPaused ? "▶️ 시간 다시 시작" : "⏸️ 시간 멈춤";
    }

    function updateTimerDisplay() {
      const m = String(Math.floor(remainingTime / 60)).padStart(2, '0');
      const s = String(remainingTime % 60).padStart(2, '0');
      document.getElementById("timer").innerText = `⏳ 남은 시간: ${m}:${s}`;
    }

    function disableInputs() {
      digits.forEach(i => i.disabled = true);
      document.getElementById("submitBtn").disabled = true;
    }

    function enableInputs(enable) {
      digits.forEach(i => i.disabled = !enable);
      document.getElementById("submitBtn").disabled = !enable;
    }

    // 입력 포커싱 및 제한
    digits.forEach((input, idx) => {
      input.addEventListener('input', (e) => {
        const val = e.target.value;
        if (isNaN(val) || val < 0 || val > 9) {
          e.target.value = '';
          return;
        }
        if (val.length === 1 && idx < digits.length - 1) {
          digits[idx + 1].focus();
        }
      });
      input.addEventListener('keydown', (e) => {
        if (e.key === "Backspace" && input.value === '' && idx > 0) {
          digits[idx - 1].focus();
        }
      });
    });

    // 초기 로드 시 저장된 문제 불러오기
    window.onload = () => {
      if (localStorage.getItem("lockAnswer")) {
        correctAnswer = localStorage.getItem("lockAnswer");
        const rules = JSON.parse(localStorage.getItem("lockRules"));
        const level = localStorage.getItem("lockLevel");
        document.getElementById("difficulty").value = level;
        const list = document.getElementById("conditionList");
        list.innerHTML = "";
        rules.forEach((r, i) => {
          const li = document.createElement("li");
          li.id = `cond${i}`;
          li.innerHTML = `🔲 ${r}`;
          list.appendChild(li);
        });
        currentConditions = generators[level]().check;
      } else {
        generateProblem(true);
      }
    };
  </script>

</body>
</html>
